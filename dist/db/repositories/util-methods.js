"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DBUtilMethods = void 0;
const tslib_1 = require("tslib");
const moment_1 = tslib_1.__importDefault(require("moment"));
class DBUtilMethods {
    static insertParams(data) {
        const fields = [];
        const variables = [];
        const values = [];
        let indx = 1;
        for (const [key, value] of Object.entries(data)) {
            if (typeof value === "bigint" ||
                typeof value === "boolean" ||
                typeof value === "number" ||
                typeof value === "string" ||
                typeof value === "object") {
                fields.push(this.stringToSnake(key));
                variables.push(`$${indx}`);
                values.push(value);
                indx++;
            }
        }
        return {
            fields,
            variables,
            values,
        };
    }
    static updateParams(data) {
        const fields = [];
        const values = [];
        let index = 1;
        for (const [key, value] of Object.entries(data)) {
            if (typeof value === "bigint" ||
                typeof value === "boolean" ||
                typeof value === "number" ||
                typeof value === "string" ||
                typeof value === "object") {
                fields.push(`"${this.stringToSnake(key)}" = $${index}`);
                values.push(value);
                index++;
            }
        }
        return {
            fields,
            values,
            index,
        };
    }
    static prepareValue(val, withQuoteString = true, seen = undefined) {
        // null and undefined are both null for postgres
        if (val == null) {
            return "NULL";
        }
        else if (val instanceof Date) {
            return (0, moment_1.default)().format("DD.MM.YYYY HH:mm:ss");
        }
        else if (Array.isArray(val)) {
            return this.arrayString(val);
        }
        else if (typeof val === "object") {
            return this.prepareObject(val, seen);
        }
        else if (typeof val === "string") {
            return withQuoteString
                ? `'${val.replace(/'/g, "''")}'`
                : val.replace(/'/g, "''");
        }
        return val.toString();
    }
    static stringToSnake(str) {
        let res = "";
        res += str.toLowerCase()[0]; // Birinchi harfi Capital latter bo'lishi mumkin
        for (let i = 1; i < str.length; i++) {
            const currChar = str[i];
            const currCharLowercase = currChar.toLowerCase();
            if (currChar === currCharLowercase) {
                res += currChar;
            }
            else {
                res += `_${currCharLowercase}`;
            }
        }
        return res;
    }
    static stringToCamel(str) {
        return str.toLowerCase().replace(/([-_][a-z])/gi, ($1) => {
            return $1.toUpperCase().replace("-", "").replace("_", "");
        });
    }
    static objToSnake(obj) {
        let res = {};
        for (const key of Object.keys(obj)) {
            res[this.stringToSnake(key)] = obj[key];
        }
        return res;
    }
    static objListToSnake(obj) {
        return obj.map((o) => this.objToSnake(o));
    }
    static objToCamel(obj) {
        if (!obj) {
            return obj;
        }
        const res = {};
        for (const key of Object.keys(obj)) {
            if (Array.isArray(obj[key]) &&
                obj[key].every((item) => typeof item === "object")) {
                res[this.stringToCamel(key)] = obj[key].map((o) => this.objToCamel(o));
            }
            else if (typeof obj[key] == "object" &&
                !(0, moment_1.default)(obj[key], "YYYY-MM-DD").isValid() &&
                !Array.isArray(obj[key])) {
                res[this.stringToCamel(key)] = this.objToCamel(obj[key]);
            }
            else {
                res[this.stringToCamel(key)] = obj[key];
            }
        }
        return res;
    }
    static objListToCamel(obj) {
        if (!Array.isArray(obj))
            return [];
        return obj.map((o) => this.objToCamel(o));
    }
    /* Private Methods */
    static prepareObject(val, withSqlString, seen = []) {
        if (val && typeof val.toPostgres === "function") {
            seen = seen || [];
            if (seen.indexOf(val) !== -1) {
                throw new Error('Circular reference detected while preparing "' + val + '" for query');
            }
            seen.push(val);
            return this.prepareValue(val.toPostgres(this.prepareValue), withSqlString, seen);
        }
        return JSON.stringify(val);
    }
    static arrayString(val) {
        let result = "{";
        for (let i = 0; i < val.length; i++) {
            if (i > 0) {
                result = result + ",";
            }
            if (val[i] === null || typeof val[i] === "undefined") {
                result = result + "NULL";
            }
            else if (Array.isArray(val[i])) {
                result = result + this.arrayString(val[i]);
            }
            else if (val[i] instanceof Buffer) {
                result += "\\\\x" + val[i].toString("hex");
            }
            else {
                result += this.escapeElement(this.prepareValue(val[i]));
            }
        }
        result = result + "}";
        return result;
    }
    static escapeElement(elementRepresentation) {
        const escaped = elementRepresentation
            .replace(/\\/g, "\\\\")
            .replace(/"/g, '\\"');
        return '"' + escaped + '"';
    }
}
exports.DBUtilMethods = DBUtilMethods;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC1tZXRob2RzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RiL3JlcG9zaXRvcmllcy91dGlsLW1ldGhvZHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDREQUE0QjtBQUc1QixNQUFhLGFBQWE7SUFDeEIsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFZO1FBQzlCLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUM1QixNQUFNLFNBQVMsR0FBVSxFQUFFLENBQUM7UUFDNUIsTUFBTSxNQUFNLEdBQVUsRUFBRSxDQUFDO1FBQ3pCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUViLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDaEQsSUFDRSxPQUFPLEtBQUssS0FBSyxRQUFRO2dCQUN6QixPQUFPLEtBQUssS0FBSyxTQUFTO2dCQUMxQixPQUFPLEtBQUssS0FBSyxRQUFRO2dCQUN6QixPQUFPLEtBQUssS0FBSyxRQUFRO2dCQUN6QixPQUFPLEtBQUssS0FBSyxRQUFRLEVBQ3pCLENBQUM7Z0JBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUMzQixNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuQixJQUFJLEVBQUUsQ0FBQztZQUNULENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTztZQUNMLE1BQU07WUFDTixTQUFTO1lBQ1QsTUFBTTtTQUNQLENBQUM7SUFDSixDQUFDO0lBRUQsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFZO1FBQzlCLE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztRQUM1QixNQUFNLE1BQU0sR0FB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QUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QyxDQUFDO2lCQUFNLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQyxZQUFZLE1BQU0sRUFBRSxDQUFDO2dCQUNwQyxNQUFNLElBQUksT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDN0MsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLE1BQU0sSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxRCxDQUFDO1FBQ0gsQ0FBQztRQUNELE1BQU0sR0FBRyxNQUFNLEdBQUcsR0FBRyxDQUFDO1FBQ3RCLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFTyxNQUFNLENBQUMsYUFBYSxDQUFDLHFCQUE2QjtRQUN4RCxNQUFNLE9BQU8sR0FBRyxxQkFBcUI7YUFDbEMsT0FBTyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUM7YUFDdEIsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN4QixPQUFPLEdBQUcsR0FBRyxPQUFPLEdBQUcsR0FBRyxDQUFDO0lBQzdCLENBQUM7Q0FDRjtBQXpNRCxzQ0F5TUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9tZW50IGZyb20gXCJtb21lbnRcIjtcclxuaW1wb3J0IHsgQ29tbW9uRXhjZXB0aW9uIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9lcnJvcnNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBEQlV0aWxNZXRob2RzIHtcclxuICBzdGF0aWMgaW5zZXJ0UGFyYW1zKGRhdGE6IG9iamVjdCkge1xyXG4gICAgY29uc3QgZmllbGRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3QgdmFyaWFibGVzOiBhbnlbXSA9IFtdO1xyXG4gICAgY29uc3QgdmFsdWVzOiBhbnlbXSA9IFtdO1xyXG4gICAgbGV0IGluZHggPSAxO1xyXG5cclxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGRhdGEpKSB7XHJcbiAgICAgIGlmIChcclxuICAgICAgICB0eXBlb2YgdmFsdWUgPT09IFwiYmlnaW50XCIgfHxcclxuICAgICAgICB0eXBlb2YgdmFsdWUgPT09IFwiYm9vbGVhblwiIHx8XHJcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcIm51bWJlclwiIHx8XHJcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiIHx8XHJcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcIm9iamVjdFwiXHJcbiAgICAgICkge1xyXG4gICAgICAgIGZpZWxkcy5wdXNoKHRoaXMuc3RyaW5nVG9TbmFrZShrZXkpKTtcclxuICAgICAgICB2YXJpYWJsZXMucHVzaChgJCR7aW5keH1gKTtcclxuICAgICAgICB2YWx1ZXMucHVzaCh2YWx1ZSk7XHJcbiAgICAgICAgaW5keCsrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgZmllbGRzLFxyXG4gICAgICB2YXJpYWJsZXMsXHJcbiAgICAgIHZhbHVlcyxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgdXBkYXRlUGFyYW1zKGRhdGE6IG9iamVjdCkge1xyXG4gICAgY29uc3QgZmllbGRzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3QgdmFsdWVzOiBhbnlbXSA9IFtdO1xyXG4gICAgbGV0IGluZGV4ID0gMTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkYXRhKSkge1xyXG4gICAgICBpZiAoXHJcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcImJpZ2ludFwiIHx8XHJcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcImJvb2xlYW5cIiB8fFxyXG4gICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gXCJudW1iZXJcIiB8fFxyXG4gICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIiB8fFxyXG4gICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIlxyXG4gICAgICApIHtcclxuICAgICAgICBmaWVsZHMucHVzaChgXCIke3RoaXMuc3RyaW5nVG9TbmFrZShrZXkpfVwiID0gJCR7aW5kZXh9YCk7XHJcbiAgICAgICAgdmFsdWVzLnB1c2godmFsdWUpO1xyXG4gICAgICAgIGluZGV4Kys7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBmaWVsZHMsXHJcbiAgICAgIHZhbHVlcyxcclxuICAgICAgaW5kZXgsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIHByZXBhcmVWYWx1ZShcclxuICAgIHZhbDogYW55LFxyXG4gICAgd2l0aFF1b3RlU3RyaW5nID0gdHJ1ZSxcclxuICAgIHNlZW46IGFueSA9IHVuZGVmaW5lZFxyXG4gICk6IHN0cmluZyB7XHJcbiAgICAvLyBudWxsIGFuZCB1bmRlZmluZWQgYXJlIGJvdGggbnVsbCBmb3IgcG9zdGdyZXNcclxuICAgIGlmICh2YWwgPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gXCJOVUxMXCI7XHJcbiAgICB9IGVsc2UgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpIHtcclxuICAgICAgcmV0dXJuIG1vbWVudCgpLmZvcm1hdChcIkRELk1NLllZWVkgSEg6bW06c3NcIik7XHJcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5hcnJheVN0cmluZyh2YWwpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSBcIm9iamVjdFwiKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnByZXBhcmVPYmplY3QodmFsLCBzZWVuKTtcclxuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gXCJzdHJpbmdcIikge1xyXG4gICAgICByZXR1cm4gd2l0aFF1b3RlU3RyaW5nXHJcbiAgICAgICAgPyBgJyR7dmFsLnJlcGxhY2UoLycvZywgXCInJ1wiKX0nYFxyXG4gICAgICAgIDogdmFsLnJlcGxhY2UoLycvZywgXCInJ1wiKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsLnRvU3RyaW5nKCk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgc3RyaW5nVG9TbmFrZShzdHI6IHN0cmluZykge1xyXG4gICAgbGV0IHJlcyA9IFwiXCI7XHJcblxyXG4gICAgcmVzICs9IHN0ci50b0xvd2VyQ2FzZSgpWzBdOyAvLyBCaXJpbmNoaSBoYXJmaSBDYXBpdGFsIGxhdHRlciBibydsaXNoaSBtdW1raW5cclxuXHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IHN0ci5sZW5ndGg7IGkrKykge1xyXG4gICAgICBjb25zdCBjdXJyQ2hhciA9IHN0cltpXTtcclxuICAgICAgY29uc3QgY3VyckNoYXJMb3dlcmNhc2UgPSBjdXJyQ2hhci50b0xvd2VyQ2FzZSgpO1xyXG5cclxuICAgICAgaWYgKGN1cnJDaGFyID09PSBjdXJyQ2hhckxvd2VyY2FzZSkge1xyXG4gICAgICAgIHJlcyArPSBjdXJyQ2hhcjtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXMgKz0gYF8ke2N1cnJDaGFyTG93ZXJjYXNlfWA7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIHN0cmluZ1RvQ2FtZWwoc3RyOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiBzdHIudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8oWy1fXVthLXpdKS9naSwgKCQxKSA9PiB7XHJcbiAgICAgIHJldHVybiAkMS50b1VwcGVyQ2FzZSgpLnJlcGxhY2UoXCItXCIsIFwiXCIpLnJlcGxhY2UoXCJfXCIsIFwiXCIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgb2JqVG9TbmFrZShvYmopIHtcclxuICAgIGxldCByZXMgPSB7fTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhvYmopKSB7XHJcbiAgICAgIHJlc1t0aGlzLnN0cmluZ1RvU25ha2Uoa2V5KV0gPSBvYmpba2V5XTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIG9iakxpc3RUb1NuYWtlKG9iajogYW55W10pIHtcclxuICAgIHJldHVybiBvYmoubWFwKChvKSA9PiB0aGlzLm9ialRvU25ha2UobykpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIG9ialRvQ2FtZWwob2JqKSB7XHJcbiAgICBpZiAoIW9iaikge1xyXG4gICAgICByZXR1cm4gb2JqO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlcyA9IHt9O1xyXG5cclxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKG9iaikpIHtcclxuICAgICAgaWYgKFxyXG4gICAgICAgIEFycmF5LmlzQXJyYXkob2JqW2tleV0pICYmXHJcbiAgICAgICAgb2JqW2tleV0uZXZlcnkoKGl0ZW0pID0+IHR5cGVvZiBpdGVtID09PSBcIm9iamVjdFwiKVxyXG4gICAgICApIHtcclxuICAgICAgICByZXNbdGhpcy5zdHJpbmdUb0NhbWVsKGtleSldID0gb2JqW2tleV0ubWFwKChvKSA9PiB0aGlzLm9ialRvQ2FtZWwobykpO1xyXG4gICAgICB9IGVsc2UgaWYgKFxyXG4gICAgICAgIHR5cGVvZiBvYmpba2V5XSA9PSBcIm9iamVjdFwiICYmXHJcbiAgICAgICAgIW1vbWVudChvYmpba2V5XSwgXCJZWVlZLU1NLUREXCIpLmlzVmFsaWQoKSAmJlxyXG4gICAgICAgICFBcnJheS5pc0FycmF5KG9ialtrZXldKVxyXG4gICAgICApIHtcclxuICAgICAgICByZXNbdGhpcy5zdHJpbmdUb0NhbWVsKGtleSldID0gdGhpcy5vYmpUb0NhbWVsKG9ialtrZXldKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXNbdGhpcy5zdHJpbmdUb0NhbWVsKGtleSldID0gb2JqW2tleV07XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcmVzO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIG9iakxpc3RUb0NhbWVsKG9iajogYW55W10pIHtcclxuICAgIGlmICghQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gW107XHJcbiAgICByZXR1cm4gb2JqLm1hcCgobykgPT4gdGhpcy5vYmpUb0NhbWVsKG8pKTtcclxuICB9XHJcblxyXG4gIC8qIFByaXZhdGUgTWV0aG9kcyAqL1xyXG5cclxuICBwcml2YXRlIHN0YXRpYyBwcmVwYXJlT2JqZWN0KFxyXG4gICAgdmFsOiBhbnksXHJcbiAgICB3aXRoU3FsU3RyaW5nOiBib29sZWFuLFxyXG4gICAgc2VlbjogYW55ID0gW11cclxuICApOiBzdHJpbmcge1xyXG4gICAgaWYgKHZhbCAmJiB0eXBlb2YgdmFsLnRvUG9zdGdyZXMgPT09IFwiZnVuY3Rpb25cIikge1xyXG4gICAgICBzZWVuID0gc2VlbiB8fCBbXTtcclxuICAgICAgaWYgKHNlZW4uaW5kZXhPZih2YWwpICE9PSAtMSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICdDaXJjdWxhciByZWZlcmVuY2UgZGV0ZWN0ZWQgd2hpbGUgcHJlcGFyaW5nIFwiJyArIHZhbCArICdcIiBmb3IgcXVlcnknXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgc2Vlbi5wdXNoKHZhbCk7XHJcbiAgICAgIHJldHVybiB0aGlzLnByZXBhcmVWYWx1ZShcclxuICAgICAgICB2YWwudG9Qb3N0Z3Jlcyh0aGlzLnByZXBhcmVWYWx1ZSksXHJcbiAgICAgICAgd2l0aFNxbFN0cmluZyxcclxuICAgICAgICBzZWVuXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXRpYyBhcnJheVN0cmluZyh2YWw6IHJlYWRvbmx5IGFueVtdKSB7XHJcbiAgICBsZXQgcmVzdWx0ID0gXCJ7XCI7XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZhbC5sZW5ndGg7IGkrKykge1xyXG4gICAgICBpZiAoaSA+IDApIHtcclxuICAgICAgICByZXN1bHQgPSByZXN1bHQgKyBcIixcIjtcclxuICAgICAgfVxyXG4gICAgICBpZiAodmFsW2ldID09PSBudWxsIHx8IHR5cGVvZiB2YWxbaV0gPT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICByZXN1bHQgPSByZXN1bHQgKyBcIk5VTExcIjtcclxuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZhbFtpXSkpIHtcclxuICAgICAgICByZXN1bHQgPSByZXN1bHQgKyB0aGlzLmFycmF5U3RyaW5nKHZhbFtpXSk7XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsW2ldIGluc3RhbmNlb2YgQnVmZmVyKSB7XHJcbiAgICAgICAgcmVzdWx0ICs9IFwiXFxcXFxcXFx4XCIgKyB2YWxbaV0udG9TdHJpbmcoXCJoZXhcIik7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ICs9IHRoaXMuZXNjYXBlRWxlbWVudCh0aGlzLnByZXBhcmVWYWx1ZSh2YWxbaV0pKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmVzdWx0ID0gcmVzdWx0ICsgXCJ9XCI7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXNjYXBlRWxlbWVudChlbGVtZW50UmVwcmVzZW50YXRpb246IHN0cmluZykge1xyXG4gICAgY29uc3QgZXNjYXBlZCA9IGVsZW1lbnRSZXByZXNlbnRhdGlvblxyXG4gICAgICAucmVwbGFjZSgvXFxcXC9nLCBcIlxcXFxcXFxcXCIpXHJcbiAgICAgIC5yZXBsYWNlKC9cIi9nLCAnXFxcXFwiJyk7XHJcbiAgICByZXR1cm4gJ1wiJyArIGVzY2FwZWQgKyAnXCInO1xyXG4gIH1cclxufVxyXG4iXX0=